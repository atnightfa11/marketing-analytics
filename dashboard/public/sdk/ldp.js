function e(){if("undefined"==typeof crypto)throw new Error("Web Crypto API is required for the SDK.");if(!crypto.getRandomValues)throw new Error("crypto.getRandomValues is not available.");return crypto}function t(t){const n=new Uint8Array(t);return e().getRandomValues(n),Array.from(n,e=>e.toString(16).padStart(2,"0")).join("")}function n(){const t=new Uint32Array(1);return e().getRandomValues(t),t[0]/4294967295}function i(e){return e>=1||!(e<=0)&&n()<e}function s(e,t){const{p:n,q:i}=function(e){const t=Math.exp(e),n=t/(1+t);return{p:n,q:1-n}}(e);return{p:t*n+.5*(1-t),q:t*i+.5*(1-t)}}function r(e,t,i){const{p:r,q:o}=s(t,i),a=r,l=function(e){return n()<e?1:0}(a);return{bit:l,p:r,q:o,variance:a*(1-a)}}class o{constructor(e=1.5){this.epsilonCap=e,this.memo=new Map}currentDayKey(){const e=new Date;return new Date(Date.UTC(e.getUTCFullYear(),e.getUTCMonth(),e.getUTCDate())).toISOString()}getDailyPresence(e,t){const n=this.currentDayKey(),i=this.memo.get(n);if(!i){const i=r(0,e,t),s={bit:i.bit,epsilon:e,p:i.p,q:i.q,variance:i.variance};return this.memo.set(n,{epsilonTotal:e,report:s}),this.trimOld(),s}return i.epsilonTotal+e>this.epsilonCap?null:(i.epsilonTotal+=e,this.memo.set(n,i),i.report)}trimOld(){const e=Date.now();for(const[t]of this.memo)e-Date.parse(t)>864e5&&this.memo.delete(t)}}class a{constructor(e,t,n,i){this.config=e,this.logger=t,this.onFailure=n,this.onSuccess=i,this.buffer=[],this.flushTimer=null,this.backoffMs=1e3,this.maxBackoffMs=6e4,this.visibilityListener=null,this.visibilityListener=this.setupVisibilityObservers()}enqueue(e){this.buffer.push(e),this.logger.debug(`Enqueued ${e.kind}. buffer=${this.buffer.length}`),this.buffer.length>=this.config.maxBatchSize?this.flush("max-batch"):this.scheduleFlush()}async flush(e){if(0===this.buffer.length)return;const t=this.buffer.splice(0,this.buffer.length);this.flushTimer&&(clearTimeout(this.flushTimer),this.flushTimer=null),this.logger.debug(`Flushing ${t.length} events because ${e}`);try{await this.postBatch(t),this.backoffMs=1e3,this.onSuccess()}catch(e){this.logger.error("Failed to flush batch",e),this.onFailure(),this.backoffMs=Math.min(2*this.backoffMs,this.maxBackoffMs),this.buffer.unshift(...t.slice(0,this.config.maxBatchSize))}}scheduleFlush(){if(this.flushTimer)return;const e=Math.floor(250*Math.random());this.flushTimer=setTimeout(()=>{this.flush("interval")},this.config.flushIntervalMs+e)}async postBatch(e){const t=new AbortController,n=setTimeout(()=>t.abort(),2e4);try{const n=await fetch(this.config.shuffleUrl,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.config.uploadToken}`},body:JSON.stringify({token:this.config.uploadToken,nonce:e[0]?.nonce,batch:e}),signal:t.signal,keepalive:!0});if(!n.ok)throw new Error(`Shuffle endpoint responded with ${n.status}`)}finally{clearTimeout(n)}}setupVisibilityObservers(){if("undefined"==typeof window||"undefined"==typeof document)return null;const e=()=>{"hidden"===document.visibilityState&&this.flush("visibilitychange")},t=()=>{this.flush("beforeunload")};return document.addEventListener("visibilitychange",e),window.addEventListener("beforeunload",t),()=>{document.removeEventListener("visibilitychange",e),window.removeEventListener("beforeunload",t)}}destroy(){this.visibilityListener&&this.visibilityListener(),this.flushTimer&&(clearTimeout(this.flushTimer),this.flushTimer=null)}}class l{constructor(e){this.enabled=e}enable(){this.enabled=!0}debug(e,t){this.enabled&&console.debug(`[analytics-sdk] ${e}`,t??"")}warn(e,t){this.enabled&&console.warn(`[analytics-sdk] ${e}`,t??"")}error(e,t){this.enabled&&console.error(`[analytics-sdk] ${e}`,t??"")}}function u(e){return new l(e)}let c=null,h=null,f=u(!1),p=new o,b=0,d=0;function g(){const e=c,t=h;if(!e||!t)throw new Error("Marketing analytics SDK has not been configured.");if(d&&Date.now()<d)throw new Error("Circuit breaker open; skipping event submission.");return{config:e,collector:t}}function m(){b+=1,b>=10&&(d=Date.now()+3e5,f.warn("Circuit breaker engaged; pausing dispatch for 5 minutes."))}function y(){b=0,d=0}function v(e,n,i,s,r){return{site_id:e.siteId,kind:n,payload:i,epsilon_used:s,sampling_rate:r,client_timestamp:(new Date).toISOString(),nonce:t(16)}}function w(e){if(!e.shuffleUrl)throw new Error("shuffleUrl is required.");c={...e,flushIntervalMs:e.flushIntervalMs??18e4,maxBatchSize:e.maxBatchSize??50},f=u(Boolean(e.debug)),h=new a(c,f,m,y),p=new o(e.presenceEpsilonCap??1.5),f.debug("Marketing analytics SDK configured.")}function k(){f.enable()}function T(e,t={}){const{config:n,collector:s}=g();if(!i(n.samplingRate))return f.debug("Pageview dropped by sampling."),!1;const o=r(0,n.epsilon.pageview,n.samplingRate),a=v(n,"pageviews",{url:e,randomized_bit:o.bit,probability_true:o.p,probability_false:o.q,variance:o.variance,metadata:t},n.epsilon.pageview,n.samplingRate);return s.enqueue(a),!0}function q(e){const{config:t,collector:n}=g();if(!i(t.samplingRate))return f.debug("Session start dropped by sampling."),!1;const s=r(0,t.epsilon.session,t.samplingRate),o=v(t,"sessions",{randomized_bit:s.bit,probability_true:s.p,probability_false:s.q,variance:s.variance,referrer_bucket:e.referrerBucket,engagement_bucket:e.engagementBucket},t.epsilon.session,t.samplingRate);return n.enqueue(o),!0}function S(e){const{config:t,collector:n}=g();if(!i(t.samplingRate))return f.debug("Conversion dropped by sampling."),!1;const s=r(0,t.epsilon.conversion,t.samplingRate),o=v(t,"conversions",{conversion_type:e.conversionType,randomized_bit:s.bit,probability_true:s.p,probability_false:s.q,variance:s.variance},t.epsilon.conversion,t.samplingRate);return n.enqueue(o),!0}function _(){const{config:e,collector:t}=g(),n=p.getDailyPresence(e.epsilon.presence,e.samplingRate);return n?(t.enqueue(v(e,"uniques",{randomized_bit:n.bit,probability_true:n.p,probability_false:n.q,variance:n.variance},e.epsilon.presence,e.samplingRate)),n):(f.warn("Presence epsilon cap hit; skipping presence report."),null)}function M(){const{collector:e}=g();return e.flush("manual")}function D(e,t){return s(e,t)}e();export{w as configure,k as enableDebug,M as flush,D as getAdjustedProbability,_ as reportPresence,S as sendConversion,T as sendPageview,q as sendSessionStart};
//# sourceMappingURL=index.js.map
